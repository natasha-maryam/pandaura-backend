
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Wrapper B - Complex Document Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-section { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        .enhancement-info { background: #e8f5e8; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #28a745; }
        .file-input { margin: 10px 0; }
        .response { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .error { background: #ffe6e6; border: 1px solid #ff9999; }
        .success { background: #e6ffe6; border: 1px solid #99ff99; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        textarea { width: 100%; height: 120px; margin: 10px 0; }
        .complex-examples { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 15px 0; }
        .complex-example { background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; }
        .complex-example h4 { margin-top: 0; color: #495057; }
        .feature-list { background: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #ffeaa7; }
        .code-block { background: #f4f4f4; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>🚀 Enhanced Wrapper B - Complex Document Processor</h1>
    <p>Test the enhanced Document & Logic Analyst with complex technical specifications and PLC functional design documents.</p>

    <div class="enhancement-info">
        <h3>🆕 Enhanced Capabilities for Complex Documents</h3>
        <ul>
            <li><strong>Large Document Processing:</strong> Handles 50+ page technical specifications systematically</li>
            <li><strong>Platform Migration:</strong> M580 → S7-1500, Rockwell → Siemens, etc.</li>
            <li><strong>FDS Analysis:</strong> Parses Functional Design Specifications with section cross-referencing</li>
            <li><strong>Safety Preservation:</strong> Maintains safety requirements during platform conversions</li>
            <li><strong>Extended Timeout:</strong> 5 minutes for complex analysis vs 3 minutes for standard</li>
            <li><strong>Enhanced Context:</strong> Better technical term extraction and section analysis</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>🔧 Health Check</h3>
        <button onclick="testHealth()">Check Enhanced Wrapper B Health</button>
        <div id="health-response" class="response"></div>
    </div>

    <div class="test-section">
        <h3>📤 Complex Document Upload</h3>
        <div class="file-input">
            <label><strong>Upload Complex Documents:</strong> (FDS, Technical Specs, Large PDFs)</label><br>
            <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.csv,.xls,.xlsx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp,.bmp,.tiff,.st,.scl,.xml,.l5x,.ap11,.tsproj,.plcproj">
        </div>
        <div id="file-list" class="file-list"></div>
        
        <label><strong>Complex Analysis Prompt:</strong></label>
        <textarea id="promptInput" placeholder="Enter your complex analysis request. Examples:

• Convert the Schneider M580 Hot Standby system described in this FDS to equivalent Siemens S7-1500 redundancy architecture with complete SCL code
• Extract all I/O requirements from this 80-page specification and create a comprehensive tag database
• Analyze the safety systems described in this document and generate corresponding safety function blocks
• Create a migration plan from the existing PLC architecture to a modern platform
• Generate complete control code based on the functional requirements in this specification"></textarea>
        
        <div style="margin: 10px 0;">
            <label><strong>Target Platform:</strong></label>
            <select id="vendorSelect" style="margin-left: 10px; padding: 5px;">
                <option value="Siemens">Siemens S7-1500/TIA Portal</option>
                <option value="Rockwell">Rockwell Studio 5000</option>
                <option value="Beckhoff">Beckhoff TwinCAT</option>
                <option value="Generic">Generic/Platform Independent</option>
            </select>
        </div>
        
        <button onclick="testComplexAnalysis()" id="testBtn">🚀 Start Complex Analysis</button>
        <div id="wrapper-response" class="response"></div>
    </div>

    <div class="test-section">
        <h3>🎯 Complex Document Examples</h3>
        <div class="complex-examples">
            <div class="complex-example">
                <h4>🔄 Platform Migration</h4>
                <button onclick="setComplexPrompt('migration')">M580 → S7-1500 Migration</button>
                <p>Convert Schneider M580 Hot Standby system to Siemens S7-1500 redundancy with complete code generation.</p>
            </div>
            <div class="complex-example">
                <h4>📋 FDS Analysis</h4>
                <button onclick="setComplexPrompt('fds_analysis')">Full FDS Analysis</button>
                <p>Comprehensive analysis of Functional Design Specification with I/O extraction and control logic.</p>
            </div>
            <div class="complex-example">
                <h4>🛡️ Safety System Design</h4>
                <button onclick="setComplexPrompt('safety_design')">Safety System Generation</button>
                <p>Extract safety requirements and generate safety-certified control code.</p>
            </div>
            <div class="complex-example">
                <h4>🏗️ System Architecture</h4>
                <button onclick="setComplexPrompt('architecture')">Architecture Analysis</button>
                <p>Complete system architecture analysis with hardware and software recommendations.</p>
            </div>
        </div>
    </div>

    <div class="feature-list">
        <h3>📊 Enhanced Processing Features</h3>
        <ul>
            <li><strong>Document Sectioning:</strong> Automatic section detection and cross-referencing</li>
            <li><strong>Technical Term Extraction:</strong> Identifies PLC, SCADA, safety, and control terminology</li>
            <li><strong>Size-Adaptive Processing:</strong> Different strategies for large vs small documents</li>
            <li><strong>Platform-Specific Output:</strong> Generates vendor-appropriate code and configurations</li>
            <li><strong>Comprehensive Artifacts:</strong> Code, tables, reports, and implementation guides</li>
        </ul>
    </div>

    <script>
        const API_BASE = '/api/assistant';
        
        // Update file list display
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            
            Array.from(e.target.files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                const sizeKB = (file.size / 1024).toFixed(1);
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const fileType = getFileTypeIcon(file.name);
                const isLarge = file.size > 1024 * 1024;
                const sizeDisplay = isLarge ? `${sizeMB} MB` : `${sizeKB} KB`;
                const complexIndicator = isLarge ? ' 🎯 COMPLEX' : '';
                fileItem.innerHTML = `${fileType} ${file.name} (${sizeDisplay})${complexIndicator}`;
                fileList.appendChild(fileItem);
            });
        });

        function getFileTypeIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'xml': '🔷', 'l5x': '🔶', 'st': '📝', 'scl': '📝',
                'pdf': '📄', 'doc': '📄', 'docx': '📄', 'txt': '📄',
                'csv': '📊', 'xls': '📊', 'xlsx': '📊',
                'png': '🖼️', 'jpg': '🖼️', 'jpeg': '🖼️', 'gif': '🖼️'
            };
            return icons[ext] || '📁';
        }

        async function testHealth() {
            const responseDiv = document.getElementById('health-response');
            responseDiv.textContent = '⏳ Checking enhanced capabilities...';
            responseDiv.className = 'response';
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                responseDiv.textContent = JSON.stringify(data, null, 2);
                responseDiv.className = response.ok ? 'response success' : 'response error';
            } catch (error) {
                responseDiv.textContent = `❌ Error: ${error.message}`;
                responseDiv.className = 'response error';
            }
        }

        async function testComplexAnalysis() {
            const files = document.getElementById('fileInput').files;
            const prompt = document.getElementById('promptInput').value;
            const vendor = document.getElementById('vendorSelect').value;
            const responseDiv = document.getElementById('wrapper-response');
            const testBtn = document.getElementById('testBtn');
            
            if (!prompt.trim()) {
                alert('⚠️ Please enter a complex analysis prompt');
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = '🔄 Processing Complex Document...';
            responseDiv.textContent = '⏳ Enhanced processing for complex documents...\nThis may take up to 5 minutes for large technical specifications.\nUsing improved analysis algorithms for systematic document processing.';
            responseDiv.className = 'response';
            
            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('vendor_selection', vendor);
                formData.append('projectId', 'complex-test-project');
                
                // Add all files
                Array.from(files).forEach(file => {
                    formData.append('files', file);
                });
                
                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/wrapperB`, {
                    method: 'POST',
                    body: formData
                });
                
                const processingTime = Date.now() - startTime;
                const data = await response.json();
                
                let displayText = `✅ Complex Analysis Complete (${(processingTime/1000).toFixed(1)}s)\n\n`;
                displayText += JSON.stringify(data, null, 2);
                
                responseDiv.textContent = displayText;
                responseDiv.className = response.ok && data.status === 'ok' ? 'response success' : 'response error';
                
                // Show artifacts summary if available
                if (data.artifacts) {
                    let artifactSummary = '\n\n📊 Generated Artifacts:\n';
                    if (data.artifacts.code?.length > 0) {
                        artifactSummary += `- Code files: ${data.artifacts.code.length}\n`;
                    }
                    if (data.artifacts.tables?.length > 0) {
                        artifactSummary += `- Data tables: ${data.artifacts.tables.length}\n`;
                    }
                    if (data.artifacts.reports?.length > 0) {
                        artifactSummary += `- Technical reports: ${data.artifacts.reports.length}\n`;
                    }
                    responseDiv.textContent += artifactSummary;
                }
                
            } catch (error) {
                responseDiv.textContent = `❌ Complex Analysis Error: ${error.message}`;
                responseDiv.className = 'response error';
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '🚀 Start Complex Analysis';
            }
        }

        function setComplexPrompt(type) {
            const prompts = {
                'migration': 'Analyze the uploaded PLC Functional Design Specification and convert the Schneider M580 Hot Standby system to an equivalent Siemens S7-1500 redundancy architecture. Generate complete SCL code including: 1) CPU redundancy configuration, 2) I/O module mapping (X80 → ET200), 3) Communication setup (Modbus TCP), 4) Safety functions preservation, 5) Hot standby logic conversion, 6) Complete project structure with OB blocks, FBs, and DBs. Include implementation notes and validation procedures.',
                
                'fds_analysis': 'Perform comprehensive analysis of this Functional Design Specification document: 1) Extract complete I/O requirements and create structured tag database, 2) Analyze system architecture and hardware specifications, 3) Document control strategies and operating modes, 4) Extract safety requirements and emergency procedures, 5) Generate implementation timeline and validation test cases, 6) Create maintenance procedures based on system complexity. Provide detailed technical report with section references.',
                
                'safety_design': 'Extract and analyze all safety-related requirements from the uploaded specification: 1) Identify Safety Instrumented Functions (SIFs), 2) Extract emergency stop and interlock requirements, 3) Generate safety-certified function blocks, 4) Create fault detection and handling procedures, 5) Design safety system architecture, 6) Generate test procedures for safety validation. Ensure compliance with relevant safety standards.',
                
                'architecture': 'Analyze the system architecture described in the specification and provide: 1) Complete hardware architecture with component specifications, 2) Network topology and communication protocols, 3) Software architecture with module breakdown, 4) Performance analysis and capacity planning, 5) Redundancy and fault tolerance design, 6) Integration requirements and interfaces, 7) Technology roadmap and upgrade recommendations.'
            };
            
            document.getElementById('promptInput').value = prompts[type] || '';
        }
    </script>
</body>
</html>
